<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flash Card</title>
    <style>
        body {
            background-color: #3a8360;
            color: white;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            overflow: hidden;
            user-select: none; /* テキスト選択防止 */
            touch-action: none; /* ブラウザのデフォルトのタッチアクションを無効化 */
        }
        #card-container {
            width: 90%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        #text {
            font-size: 3rem;
            font-weight: bold;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .long-text { font-size: 1.8rem !important; text-align: left; width: 100%; }
        /* PCクリック用エリア */
        .tap-area { position: absolute; width: 50%; height: 100%; top: 0; z-index: 10; cursor: pointer; }
        .tap-left { left: 0; }
        .tap-right { right: 0; }
    </style>
</head>
<body>
    <div id="card-container">
        <div id="text">Loading...</div>
        <div class="tap-area tap-left" onclick="prev()"></div>
        <div class="tap-area tap-right" onclick="next()"></div>
    </div>

    <script src="./main.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const config = {
            subject: params.get("subject") || 'leap',
            start: parseInt(params.get("start") || 1),
            end: parseInt(params.get("end") || 9999),
            num: parseInt(params.get("num") || 10),
            reverse: params.get("reverse") === 'true'
        };

        let loadedData = null;
        let questions = [];
        let currentIndex = 0;
        let isBack = false;

        (async () => {
            loadedData = await fetchBookData(config.subject);
            if (!loadedData) {
                document.getElementById("text").textContent = "データの読み込みに失敗しました";
                return;
            }
            startNewSet();
        })();

        function startNewSet() {
            questions = generateSet(loadedData, config);
            currentIndex = 0;
            isBack = false;

            if (questions.length === 0) {
                document.getElementById("text").textContent = "表示できる単語がありません";
                return;
            }
            render();
        }

        function render() {
            if (currentIndex >= questions.length) {
                if (confirm("一周しました。新しいセットで繰り返しますか？")) {
                    startNewSet(); 
                } else {
                    location.href = "./index.html";
                }
                return;
            }

            const q = questions[currentIndex];
            const el = document.getElementById("text");
            const text = isBack ? q.b : q.f;
            
            el.textContent = text;
            
            if (text.length > 40 || config.subject.includes("History")) {
                el.classList.add("long-text");
            } else {
                el.classList.remove("long-text");
            }
        }

        function next() {
            if (!isBack) isBack = true;
            else {
                isBack = false;
                currentIndex++;
            }
            render();
        }

        function prev() {
            if (isBack) isBack = false;
            else {
                if (currentIndex > 0) {
                    currentIndex--;
                    isBack = true;
                } else {
                    if(confirm("トップに戻りますか？")) location.href = "./index.html";
                }
            }
            render();
        }

        function archive() {
            if (currentIndex >= questions.length) return;
            const q = questions[currentIndex];
            if (q && q.id) {
                const key = "ARCHIVE_" + config.subject;
                let archived = localStorage.getItem(key);
                archived = archived ? archived.split(",") : [];
                
                if (!archived.includes(String(q.id))) {
                    archived.push(String(q.id));
                    localStorage.setItem(key, archived.join(","));
                    
                    // フィードバック表示
                    const el = document.getElementById("text");
                    el.textContent = "Archived!";
                    // 少し待ってから次へ（視覚的フィードバックのため）
                    setTimeout(() => {
                         isBack = false;
                         currentIndex++;
                         render();
                    }, 300);
                    return;
                }
            }
            // すでにアーカイブ済み等の場合は即次へ
            isBack = false;
            currentIndex++;
            render();
        }
                
        document.addEventListener("keydown", e => {
            if (e.code === "ArrowRight" || e.code === "Space") next();
            if (e.code === "ArrowLeft") prev();
            if (e.code === "ArrowDown") archive();
        });

        // --- スワイプ／フリック判定 ---
        let startX = 0;
        let startY = 0;
        let endX = 0;
        let endY = 0;

        // スワイプ／フリック
        document.addEventListener('touchmove', logSwipe, { passive: false });

        // タッチ開始
        document.addEventListener('touchstart', logSwipeStart, { passive: false });

        // タッチ終了
        document.addEventListener('touchend', logSwipeEnd, { passive: false });

        function logSwipeStart(event) {
            event.preventDefault();
            startX = event.touches[0].pageX;
            startY = event.touches[0].pageY;
            // タップ判定用に初期化
            endX = startX;
            endY = startY;
        }

        function logSwipe(event) {
            event.preventDefault();
            endX = event.touches[0].pageX;
            endY = event.touches[0].pageY;
        }

        function logSwipeEnd(event) {
            event.preventDefault();
            // 下方向へのスワイプ（Yの移動量がXの移動量より大きい）
            if(Math.abs(endX - startX) < endY - startY){
                archive();
            } 
            // 右方向へのスワイプ
            else if( 0 < (endX - startX) ) {
                prev();
            } 
            // 左方向へのスワイプ、またはタップ
            else {
                next();
            }
        }
    </script>
</body>
</html>
