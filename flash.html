<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flash Card</title>
    <style>
        body {
            background-color: #3a8360;
            color: white;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            overflow: hidden;
            user-select: none;
        }
        #card-container {
            width: 90%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        #text {
            font-size: 3rem;
            font-weight: bold;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .long-text { font-size: 1.8rem !important; text-align: left; width: 100%; }
        .tap-area { position: absolute; width: 50%; height: 100%; top: 0; z-index: 10; }
        .tap-left { left: 0; }
        .tap-right { right: 0; }
    </style>
</head>
<body>
    <div id="card-container">
        <div id="text">Loading...</div>
        <div class="tap-area tap-left" onclick="prev()"></div>
        <div class="tap-area tap-right" onclick="next()"></div>
    </div>

    <script src="./main.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const config = {
            subject: params.get("subject") || 'leap',
            start: parseInt(params.get("start") || 1),
            end: parseInt(params.get("end") || 9999),
            num: parseInt(params.get("num") || 10),
            reverse: params.get("reverse") === 'true'
        };

        let loadedData = null; // 読み込んだ全データを保持
        let questions = [];
        let currentIndex = 0;
        let isBack = false;

        // --- 初期化プロセス ---
        (async () => {
            // 1. 最初に全データを一度だけ取得 (通信はここだけ)
            loadedData = await fetchBookData(config.subject);
            
            if (!loadedData) {
                document.getElementById("text").textContent = "データの読み込みに失敗しました";
                return;
            }

            // 2. 問題セットを作成して開始
            startNewSet();
        })();

        // 新しい問題セットを生成して開始する関数
        function startNewSet() {
            // メモリ上のデータからランダム抽出 (通信なし)
            questions = generateSet(loadedData, config);
            
            currentIndex = 0;
            isBack = false;

            if (questions.length === 0) {
                document.getElementById("text").textContent = "表示できる単語がありません";
                return;
            }
            render();
        }

        function render() {
            // 終了判定
            if (currentIndex >= questions.length) {
                if (confirm("一周しました。新しいセットで繰り返しますか？")) {
                    startNewSet(); 
                } else {
                    location.href = "./index.html";
                }
                return;
            }

            const q = questions[currentIndex];
            const el = document.getElementById("text");
            const text = isBack ? q.b : q.f;
            
            el.textContent = text;
            
            if (text.length > 40 || config.subject.includes("History")) {
                el.classList.add("long-text");
            } else {
                el.classList.remove("long-text");
            }
        }

        function next() {
            if (!isBack) isBack = true;
            else {
                isBack = false;
                currentIndex++;
            }
            render();
        }

        function prev() {
            if (isBack) isBack = false;
            else {
                if (currentIndex > 0) {
                    currentIndex--;
                    isBack = true;
                } else {
                    if(confirm("トップに戻りますか？")) location.href = "./index.html";
                }
            }
            render();
        }
                
        document.addEventListener("keydown", e => {
            if (e.code === "ArrowRight" || e.code === "Space") next();
            if (e.code === "ArrowLeft") prev();
        });
    </script>
</body>
</html>
